{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ #{{ deal.id }}{% endblock %}
{% block body_class %}deal-accounts-page{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/deal_accounts.css' %}">
{% endblock %}
{% block content %}
  <div class="page-card">
    <div class="page-card-inner">
      <div class="deal-accounts-header">
        <div class="deal-accounts-header-top">
          <a class="deal-accounts-back" href="{% url 'dashboard' %}">â† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
          <div class="deal-accounts-actions">
            <button type="button"
                    class="deal-detail-btn deal-detail-btn--ghost"
                    id="openDealDetailModal">Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡</button>
            {% if deal_accounts_list %}
              <button type="button"
                      class="deal-detail-btn deal-detail-btn--primary"
                      id="openRegisterPaymentModal">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>
            {% endif %}
          </div>
        </div>
        <div class="deal-accounts-title-row">
          <h1 class="deal-accounts-title">Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ #{{ deal.id }}</h1>
          <span class="deal-accounts-pill">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨</span>
        </div>
        <p class="deal-accounts-subtitle">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø§Ù…Ù„Ù‡ â€” Ø¨Ø¯Ù‡ÛŒ/Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†ØŒ Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ùˆ Ø¨Ù†Ú¯Ø§Ù‡.</p>
      </div>
      <div class="deal-summary-card deal-summary-card--primary">
        <div class="deal-summary-item">
          <span class="deal-summary-label">Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡</span>
          <span class="deal-summary-value">{{ deal.title|default:"â€”" }}</span>
        </div>
        <div class="deal-summary-item">
          <span class="deal-summary-label">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡</span>
          <span class="deal-summary-value">{{ deal.type.name|default:"â€”" }}</span>
        </div>
        <div class="deal-summary-item">
          <span class="deal-summary-label">ØªØ§Ø±ÛŒØ® Ù…Ø¹Ø§Ù…Ù„Ù‡</span>
          <span class="deal-summary-value">{{ deal.date|default:"â€”" }}</span>
        </div>
        {% if client_receivable_balance %}
          <div class="deal-summary-item">
            <span class="deal-summary-label">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ Ø§Ø² Ù…Ø´ØªØ±ÛŒØ§Ù†</span>
            <span class="deal-summary-value">{{ client_receivable_balance|floatformat:0|intcomma }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
        {% endif %}
      </div>
      {% if summary_items %}
        <div class="deal-summary-card deal-summary-card--secondary">
          {% for s in summary_items %}
            <div class="deal-summary-item">
              <span class="deal-summary-label">{{ s.label }}</span>
              <span class="deal-summary-value">{{ s.balance|floatformat:0|intcomma }} Ø±ÛŒØ§Ù„</span>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% if transaction and ledger_rows %}
        <div class="ledger-card" style="margin-bottom: 1rem;">
          <div class="ledger-card-header">
            <div>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ â€” Ø³Ù†Ø¯ Ú©Ù…ÛŒØ³ÛŒÙˆÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡</div>
            <div class="ledger-legend">
              <span class="ledger-legend-item ledger-legend-debit">Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
              <span class="ledger-legend-item ledger-legend-credit">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</span>
              <span class="ledger-legend-item ledger-legend-settled">ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</span>
            </div>
          </div>
          <div class="ledger-table-wrapper">
            <table class="ledger-table">
              <thead>
                <tr>
                  <th class="col-account">Ø­Ø³Ø§Ø¨</th>
                  <th class="col-code">Ú©Ø¯</th>
                  <th class="col-desc">Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨</th>
                  <th class="col-counterpart">Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ (Ù‡Ù…â€ŒØ§Ø±Ø²)</th>
                  <th class="col-debit">Ø¨Ø¯Ù‡Ú©Ø§Ø±</th>
                  <th class="col-credit">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</th>
                  <th class="col-settled">ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</th>
                  <th class="col-remaining">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</th>
                  <th class="col-actions">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</th>
                </tr>
              </thead>
              <tbody>
                {% for e in ledger_rows %}
                  <tr>
                    <td class="col-account">{{ e.account_name }}</td>
                    <td class="col-code">{{ e.account_code }}</td>
                    <td class="col-desc">{{ e.account_kind|default:"â€”" }}</td>
                    <td class="col-counterpart">{{ e.counterpart_label|default:"â€”" }}</td>
                    <td class="col-debit">
                      {% if e.debit %}{{ e.debit|floatformat:0|intcomma }}{% endif %}
                    </td>
                    <td class="col-credit">
                      {% if e.credit %}{{ e.credit|floatformat:0|intcomma }}{% endif %}
                    </td>
                    <td class="col-settled">
                      {% if e.settled_amount %}
                        {{ e.settled_amount|floatformat:0|intcomma }}
                      {% else %}
                        Û°
                      {% endif %}
                    </td>
                    <td class="col-remaining">
                      {% if e.remaining_amount %}
                        {{ e.remaining_amount|floatformat:0|intcomma }}
                      {% else %}
                        Û°
                      {% endif %}
                    </td>
                    <td class="col-actions">
                      {% if e.has_payments %}
                        <button type="button"
                                class="payments-badge"
                                data-account-code="{{ e.account_code }}">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</button>
                      {% else %}
                        <span class="deal-summary-label">â€”</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                <tr class="total-row">
                  <td colspan="4">Ø¬Ù…Ø¹ Ø¯ÙØªØ±</td>
                  <td class="col-debit">{{ total_debit|floatformat:0|intcomma }}</td>
                  <td class="col-credit">{{ total_credit|floatformat:0|intcomma }}</td>
                  <td colspan="3"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="empty-accounts-state">
          <div class="icon">ğŸ“‹</div>
          <p>Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù‡Ù†ÙˆØ² Ø³Ù†Ø¯ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ (Ú©Ù…ÛŒØ³ÛŒÙˆÙ†) Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
          <p style="margin-top: 8px; font-size: 13px;">
            Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± Ø¨Ù†Ú¯Ø§Ù‡ØŒ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø°ÛŒâ€ŒÙ†ÙØ¹Ø§Ù† (Ù…Ø´ØªØ±ÛŒØ§Ù†ØŒ Ù…Ø´Ø§ÙˆØ±Ø§Ù†ØŒ Ù…Ø¯ÛŒØ± Ø¯ÙØªØ± Ùˆ â€¦) Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
          </p>
        </div>
      {% endif %}
    </div>
  </div>
  <script id="payments-data" type="application/json">{{ payments_by_account_json|safe }}</script>
  <script id="payment-url" type="application/json">{"url": "{% url 'finance:deal-account-payment' deal.id %}"}</script>
  <script>
    // Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡
    (function () {
      const overlay = document.getElementById("dealDetailModal");
      const openBtn = document.getElementById("openDealDetailModal");
      const closeBtn = document.getElementById("dealDetailModalClose");

      function setModalOpen(open) {
        if (!overlay) return;
        overlay.style.display = open ? "flex" : "none";
        overlay.setAttribute("aria-hidden", open ? "false" : "true");
        document.body.style.overflow = open ? "hidden" : "";
      }

      if (openBtn && overlay) {
        openBtn.addEventListener("click", function () {
          setModalOpen(true);
        });
      }
      if (closeBtn && overlay) {
        closeBtn.addEventListener("click", function () {
          setModalOpen(false);
        });
      }
      if (overlay) {
        overlay.addEventListener("click", function (e) {
          if (e.target && e.target.id === "dealDetailModal") {
            setModalOpen(false);
          }
        });
      }
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          setModalOpen(false);
        }
      });
    })();

    // Ù…ÙˆØ¯Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨
    (function () {
      const dataEl = document.getElementById("payments-data");
      let paymentsByAccount = {};
      if (dataEl && dataEl.textContent.trim()) {
        try {
          paymentsByAccount = JSON.parse(dataEl.textContent);
        } catch (e) {
          paymentsByAccount = {};
        }
      }

      const overlay = document.getElementById("paymentsModal");
      const closeBtn = document.getElementById("paymentsModalClose");
      const bodyEl = document.getElementById("paymentsModalBody");
      const titleEl = document.getElementById("paymentsModalTitle");

      function setPaymentsModalOpen(open) {
        if (!overlay) return;
        overlay.style.display = open ? "flex" : "none";
        overlay.setAttribute("aria-hidden", open ? "false" : "true");
        document.body.style.overflow = open ? "hidden" : "";
      }

      function formatAmount(value) {
        if (value == null) return "Û°";
        try {
          return Number(value).toLocaleString("fa-IR");
        } catch (e) {
          return String(value);
        }
      }

      function openPaymentsModal(accountCode, accountName) {
        const items = paymentsByAccount[accountCode] || [];
        titleEl.textContent = `ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨ ${accountName || accountCode}`;

        if (!items.length) {
          bodyEl.innerHTML = `
            <div class="empty-accounts-state">
              <div class="icon">ğŸ“„</div>
              <p>Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
            </div>
          `;
        } else {
          bodyEl.innerHTML = `
            <div class="ledger-table-wrapper">
              <table class="ledger-table">
                <thead>
                  <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ù†ÙˆØ¹</th>
                    <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
                    <th>Ø±ÙˆØ´</th>
                    <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                    <th>Ø±Ø³ÛŒØ¯</th>
                  </tr>
                </thead>
                <tbody>
                  ${items
                    .map(
                      (p) => `
                        <tr>
                          <td>${p.date || "â€”"}</td>
                          <td>${p.direction || "â€”"}</td>
                          <td class="col-credit">${formatAmount(p.amount)}</td>
                          <td>${p.method || "â€”"}</td>
                          <td>${p.description || "â€”"}</td>
                          <td>${
                            p.receipt_url
                              ? '<button type="button" class="payments-badge receipt-open-btn" data-receipt-url="' + (p.receipt_url || "").replace(/"/g, "&quot;") + '">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯</button>'
                              : "â€”"
                          }</td>
                        </tr>
                      `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        }

        setPaymentsModalOpen(true);
      }

      var receiptModalBlobUrl = null;
      function openReceiptModal(url) {
        const receiptOverlay = document.getElementById("receiptModal");
        const body = document.getElementById("receiptModalBody");
        const loading = document.getElementById("receiptModalLoading");
        const img = document.getElementById("receiptModalImage");
        const fallback = document.getElementById("receiptModalFallback");
        const openNewLink = document.getElementById("receiptModalOpenNew");
        if (!receiptOverlay || !url) return;
        if (receiptModalBlobUrl) {
          URL.revokeObjectURL(receiptModalBlobUrl);
          receiptModalBlobUrl = null;
        }
        loading.style.display = "block";
        if (img) { img.style.display = "none"; img.removeAttribute("src"); }
        if (fallback) fallback.style.display = "none";
        receiptOverlay.style.display = "flex";
        receiptOverlay.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
        fetch(url, { credentials: "include" })
          .then(function (r) {
            if (!r.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ");
            var ct = (r.headers.get("Content-Type") || "").split(";")[0].trim().toLowerCase();
            return r.blob().then(function (blob) {
              return { blob: blob, contentType: ct };
            });
          })
          .then(function (_) {
            var blob = _.blob, contentType = _.contentType;
            if (contentType.indexOf("image/") === 0 && img) {
              receiptModalBlobUrl = URL.createObjectURL(blob);
              img.src = receiptModalBlobUrl;
              img.style.display = "block";
              loading.style.display = "none";
            } else {
              if (openNewLink) {
                openNewLink.href = url;
                openNewLink.textContent = "Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø±Ø³ÛŒØ¯ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯";
              }
              if (fallback) fallback.style.display = "block";
              loading.style.display = "none";
            }
          })
          .catch(function () {
            if (openNewLink) {
              openNewLink.href = url;
              openNewLink.textContent = "Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø±Ø³ÛŒØ¯ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯";
            }
            if (fallback) fallback.style.display = "block";
            loading.style.display = "none";
          });
      }
      function closeReceiptModal() {
        const receiptOverlay = document.getElementById("receiptModal");
        const img = document.getElementById("receiptModalImage");
        const fallback = document.getElementById("receiptModalFallback");
        const loading = document.getElementById("receiptModalLoading");
        if (receiptOverlay) {
          receiptOverlay.style.display = "none";
          receiptOverlay.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
        }
        if (receiptModalBlobUrl) {
          URL.revokeObjectURL(receiptModalBlobUrl);
          receiptModalBlobUrl = null;
        }
        if (img) { img.removeAttribute("src"); img.style.display = "none"; }
        if (fallback) fallback.style.display = "none";
        if (loading) loading.style.display = "block";
      }
      bodyEl.addEventListener("click", function (e) {
        const btn = e.target && e.target.closest && e.target.closest(".receipt-open-btn");
        if (btn && btn.getAttribute("data-receipt-url")) {
          e.preventDefault();
          openReceiptModal(btn.getAttribute("data-receipt-url"));
        }
      });
      (function () {
        const receiptOverlay = document.getElementById("receiptModal");
        const receiptClose = document.getElementById("receiptModalClose");
        if (receiptClose) receiptClose.addEventListener("click", closeReceiptModal);
        if (receiptOverlay) {
          receiptOverlay.addEventListener("click", function (ev) {
            if (ev.target && ev.target.id === "receiptModal") closeReceiptModal();
          });
        }
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && receiptOverlay && receiptOverlay.getAttribute("aria-hidden") === "false") {
            closeReceiptModal();
          }
        });
      })();

      document.querySelectorAll(".payments-badge").forEach((btn) => {
        btn.addEventListener("click", function () {
          const code = this.getAttribute("data-account-code");
          const row = this.closest("tr");
          const nameCell = row ? row.querySelector(".col-account") : null;
          const name = nameCell ? nameCell.textContent.trim() : "";
          openPaymentsModal(code, name);
        });
      });

      if (closeBtn && overlay) {
        closeBtn.addEventListener("click", function () {
          setPaymentsModalOpen(false);
        });
      }
      if (overlay) {
        overlay.addEventListener("click", function (e) {
          if (e.target && e.target.id === "paymentsModal") {
            setPaymentsModalOpen(false);
          }
        });
      }
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          setPaymentsModalOpen(false);
        }
      });
    })();

    (function () {
      const overlay = document.getElementById("registerPaymentModal");
      const openBtn = document.getElementById("openRegisterPaymentModal");
      const closeBtn = document.getElementById("registerPaymentModalClose");
      const form = document.getElementById("registerPaymentForm");
      const messageEl = document.getElementById("registerPaymentMessage");
      const submitBtn = document.getElementById("registerPaymentSubmit");
      if (!overlay || !form) return;

      let paymentUrl = "";
      try {
        const urlEl = document.getElementById("payment-url");
        if (urlEl && urlEl.textContent) {
          paymentUrl = JSON.parse(urlEl.textContent).url;
        }
      } catch (e) {}

      function setRegisterPaymentModalOpen(open) {
        overlay.style.display = open ? "flex" : "none";
        overlay.setAttribute("aria-hidden", open ? "false" : "true");
        document.body.style.overflow = open ? "hidden" : "";
        if (!open) {
          messageEl.textContent = "";
          messageEl.className = "form-message";
        }
      }

      if (openBtn) {
        openBtn.addEventListener("click", function () {
          setRegisterPaymentModalOpen(true);
        });
      }
      if (closeBtn) {
        closeBtn.addEventListener("click", function () {
          setRegisterPaymentModalOpen(false);
        });
      }
      overlay.addEventListener("click", function (e) {
        if (e.target && e.target.id === "registerPaymentModal") {
          setRegisterPaymentModalOpen(false);
        }
      });
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && overlay.getAttribute("aria-hidden") === "false") {
          setRegisterPaymentModalOpen(false);
        }
      });

      var amountInput = document.getElementById("paymentAmount");
      if (amountInput) {
        function toEnDigits(str) {
          var fa = "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹";
          var out = "";
          for (var i = 0; i < (str || "").length; i++) {
            var idx = fa.indexOf(str[i]);
            out += idx >= 0 ? idx : str[i];
          }
          return out;
        }
        function getRawAmount() {
          var v = (amountInput.value || "").replace(/,|Ù¬|ØŒ/g, "");
          var en = toEnDigits(v);
          return en.replace(/\D/g, "");
        }
        function formatAmountInput() {
          var raw = getRawAmount();
          if (!raw) {
            amountInput.value = "";
            amountInput.setAttribute("data-raw", "");
            return;
          }
          var n = parseInt(raw, 10);
          if (isNaN(n)) {
            amountInput.setAttribute("data-raw", "");
            return;
          }
          amountInput.setAttribute("data-raw", String(n));
          amountInput.value = n.toLocaleString("fa-IR");
        }
        function allowOnlyDigits(e) {
          var k = e.key;
          if (k === "Backspace" || k === "Tab" || k === "Enter") return;
          if (e.ctrlKey || e.metaKey) return;
          if (/[0-9Û°-Û¹]/.test(k)) return;
          e.preventDefault();
        }
        amountInput.addEventListener("blur", formatAmountInput);
        amountInput.addEventListener("keydown", allowOnlyDigits);
        amountInput.addEventListener("input", function () {
          var raw = getRawAmount();
          amountInput.setAttribute("data-raw", raw ? String(parseInt(raw, 10)) : "");
        });
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (!paymentUrl) {
          messageEl.textContent = "Ø¢Ø¯Ø±Ø³ Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
          messageEl.className = "form-message error";
          return;
        }
        var fd = new FormData(form);
        var rawAmount = amountInput ? (amountInput.getAttribute("data-raw") || amountInput.value) : fd.get("amount");
        if (typeof rawAmount === "string") {
          rawAmount = rawAmount.replace(/,|Ù¬|ØŒ/g, "").replace(/[Û°-Û¹]/g, function (c) {
            return "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(c);
          }).replace(/\D/g, "");
        }
        if (!rawAmount || parseInt(rawAmount, 10) <= 0) {
          messageEl.textContent = "Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
          messageEl.className = "form-message error";
          return;
        }
        fd.set("amount", rawAmount);
        var csrf = fd.get("csrfmiddlewaretoken") || "";
        messageEl.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...";
        messageEl.className = "form-message";
        submitBtn.disabled = true;
        fetch(paymentUrl, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrf,
            "Accept": "application/json",
          },
          body: fd,
        })
          .then(function (res) {
            return res.json().then(function (data) {
              if (res.ok && data.success) {
                messageEl.textContent = data.message || "Ø«Ø¨Øª Ø´Ø¯.";
                messageEl.className = "form-message success";
                setTimeout(function () {
                  window.location.reload();
                }, 800);
              } else {
                messageEl.textContent = data.message || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´.";
                messageEl.className = "form-message error";
                submitBtn.disabled = false;
              }
            });
          })
          .catch(function () {
            messageEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
            messageEl.className = "form-message error";
            submitBtn.disabled = false;
          });
      });
    })();
  </script>
{% endblock %}
{% block modals %}
  <div class="deal-detail-modal-overlay"
       id="dealDetailModal"
       aria-hidden="true">
    <div class="deal-detail-modal"
         role="dialog"
         aria-modal="true"
         aria-labelledby="dealDetailModalTitle">
      <div class="deal-detail-modal-header">
        <h2 class="deal-detail-modal-title" id="dealDetailModalTitle">Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ #{{ deal.id }}</h2>
        <button type="button"
                class="deal-detail-modal-close"
                id="dealDetailModalClose">Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="deal-detail-modal-body">
        <div class="detail-grid">
          <div class="detail-card">
            <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡</h3>
            <div class="kv">
              <b>Ú©Ø¯ Ù…Ø¹Ø§Ù…Ù„Ù‡</b><span>{{ deal.id }}</span>
              <b>ÙˆØ¶Ø¹ÛŒØª</b><span>{{ deal.get_status_display|default:deal.status }}</span>
              <b>Ù†ÙˆØ¹</b><span>{{ deal.type.name|default:"â€”" }}</span>
              <b>Ø³Ø§Ø²Ù†Ø¯Ù‡</b><span>{{ deal.created_by.get_full_name|default:deal.created_by.username }}</span>
            </div>
          </div>
          <div class="detail-card">
            <h3>ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</h3>
            <div class="kv">
              <b>ØªØ§Ø±ÛŒØ® Ù…Ø¨Ø§ÛŒØ¹Ù‡</b><span>{{ deal.agreement_date|default:"Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡" }}</span>
              <b>ØªØ§Ø±ÛŒØ® Ø¯ÙØªØ±Ø®Ø§Ù†Ù‡</b><span>{{ deal.office_date|default:"Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡" }}</span>
              <b>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</b><span>{{ deal.created_at|date:"Y/m/d H:i" }}</span>
            </div>
          </div>
          <div class="detail-card">
            <h3>Ù…Ø¨Ø§Ù„Øº</h3>
            <div class="kv">
              <b>Ù…Ø¨Ù„Øº Ù…Ø¹Ø§Ù…Ù„Ù‡</b><span>
                {% if deal.amount %}
                  {{ deal.amount|floatformat:0|intcomma }} Ø±ÛŒØ§Ù„
                {% else %}
                  â€”
                {% endif %}
              </span>
              <b>Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡</b><span>
                {% if deal.base_price %}
                  {{ deal.base_price|floatformat:0|intcomma }} Ø±ÛŒØ§Ù„
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
              <b>Ø§Ø¶Ø§ÙÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª</b><span>
                {% if deal.overpayment %}
                  {{ deal.overpayment|floatformat:0|intcomma }} Ø±ÛŒØ§Ù„
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
              <b>Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª</b><span>
                {% if deal.overpayment_received %}
                  {{ deal.overpayment_received|floatformat:0|intcomma }} Ø±ÛŒØ§Ù„
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
            </div>
          </div>
          <div class="detail-card">
            <h3>Ø·Ø±ÙÛŒÙ†</h3>
            <div class="kv">
              <b>Ø®Ø±ÛŒØ¯Ø§Ø±Ø§Ù†</b><span>
                {% if deal.buyers.all %}
                  {{ deal.buyers.all|join:"ØŒ " }}
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
              <b>ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù†</b><span>
                {% if deal.sellers.all %}
                  {{ deal.sellers.all|join:"ØŒ " }}
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
              <b>Ù…Ø´Ø§ÙˆØ±Ø§Ù†</b><span>
                {% if deal.consultants.all %}
                  {{ deal.consultants.all|join:"ØŒ " }}
                {% else %}
                  Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                {% endif %}
              </span>
            </div>
          </div>
        </div>
        {% if deal.description %}
          <div class="detail-card" style="margin-top:10px;">
            <h3>ØªÙˆØ¶ÛŒØ­Ø§Øª</h3>
            <div class="kv">
              <b>Ø´Ø±Ø­</b><span>{{ deal.description }}</span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="deal-detail-modal-overlay"
       id="paymentsModal"
       aria-hidden="true">
    <div class="deal-detail-modal"
         role="dialog"
         aria-modal="true"
         aria-labelledby="paymentsModalTitle">
      <div class="deal-detail-modal-header">
        <h2 class="deal-detail-modal-title" id="paymentsModalTitle">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨</h2>
        <button type="button" class="deal-detail-modal-close" id="paymentsModalClose">Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="deal-detail-modal-body" id="paymentsModalBody">
        <div class="empty-accounts-state">
          <div class="icon">ğŸ“„</div>
          <p>Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="deal-detail-modal-overlay"
       id="receiptModal"
       aria-hidden="true">
    <div class="deal-detail-modal receipt-modal"
         role="dialog"
         aria-modal="true"
         aria-labelledby="receiptModalTitle">
      <div class="deal-detail-modal-header">
        <h2 class="deal-detail-modal-title" id="receiptModalTitle">Ø±Ø³ÛŒØ¯</h2>
        <button type="button" class="deal-detail-modal-close" id="receiptModalClose">Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="deal-detail-modal-body receipt-modal-body"
           id="receiptModalBody">
        <div class="receipt-loading" id="receiptModalLoading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
        <img id="receiptModalImage"
             class="receipt-image"
             alt="Ø±Ø³ÛŒØ¯"
             style="display:none" />
        <div class="receipt-fallback"
             id="receiptModalFallback"
             style="display:none">
          <p>Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¯Ø± Ù‚Ø§Ø¨ Ø§Ù…Ù† Ù…Ø±ÙˆØ±Ú¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
          <p>
            <a id="receiptModalOpenNew" href="#" target="_blank" rel="noopener">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø±Ø³ÛŒØ¯ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯</a>
          </p>
        </div>
      </div>
    </div>
  </div>
  {% if deal_accounts_list %}
    <div class="deal-detail-modal-overlay"
         id="registerPaymentModal"
         aria-hidden="true">
      <div class="deal-detail-modal"
           role="dialog"
           aria-modal="true"
           aria-labelledby="registerPaymentModalTitle">
        <div class="deal-detail-modal-header">
          <h2 class="deal-detail-modal-title" id="registerPaymentModalTitle">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h2>
          <button type="button"
                  class="deal-detail-modal-close"
                  id="registerPaymentModalClose">Ø¨Ø³ØªÙ†</button>
        </div>
        <div class="deal-detail-modal-body">
          <form id="registerPaymentForm"
                class="payment-form"
                enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
              <label for="paymentAccount">
                Ø­Ø³Ø§Ø¨ <span class="required">*</span>
              </label>
              <select id="paymentAccount" name="account_id" required>
                <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨ â€”</option>
                {% for acc in deal_accounts_list %}<option value="{{ acc.id }}">{{ acc.code }} â€” {{ acc.name }}</option>{% endfor %}
              </select>
            </div>
            <div class="form-row">
              <label for="paymentAmount">
                Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„) <span class="required">*</span>
              </label>
              <input type="text"
                     id="paymentAmount"
                     name="amount"
                     inputmode="numeric"
                     required
                     placeholder="Ù…Ø«Ø§Ù„: Û±Ù¬Û°Û°Û°Ù¬Û°Û°Û°"
                     data-raw="">
              <span class="form-hint">Ø³Ù‡â€ŒØ±Ù‚Ù… Ø³Ù‡â€ŒØ±Ù‚Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…Ø¨Ù„Øº Ø§Ø² ÙÛŒÙ„Ø¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯.</span>
            </div>
            <div class="form-row">
              <label for="paymentDirection">
                Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ <span class="required">*</span>
              </label>
              <select id="paymentDirection" name="direction" required>
                <option value="receive">Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø·Ø±Ù Ø­Ø³Ø§Ø¨</option>
                <option value="pay">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø·Ø±Ù Ø­Ø³Ø§Ø¨</option>
              </select>
            </div>
            <div class="form-row">
              <label for="paymentDate">ØªØ§Ø±ÛŒØ® (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
              <input type="text"
                     id="paymentDate"
                     name="date"
                     placeholder="Û±Û´Û°Û³/Û°Ûµ/Û±Ûµ ÛŒØ§ 2024-08-06">
            </div>
            <div class="form-row">
              <label for="paymentMethod">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª/Ø¯Ø±ÛŒØ§ÙØª</label>
              <input type="text"
                     id="paymentMethod"
                     name="method"
                     placeholder="Ù†Ù‚Ø¯ØŒ Ú©Ø§Ø±ØªØŒ Ø­ÙˆØ§Ù„Ù‡ Ùˆ ...">
            </div>
            <div class="form-row">
              <label for="paymentDescription">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
              <textarea id="paymentDescription"
                        name="description"
                        rows="2"
                        placeholder="Ø´Ø±Ø­ ØªØ±Ø§Ú©Ù†Ø´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
            </div>
            <div class="form-row">
              <label for="paymentReceipt">Ø¶Ù…ÛŒÙ…Ù‡ / ØªØµÙˆÛŒØ± Ø±Ø³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
              <input type="file"
                     id="paymentReceipt"
                     name="receipt"
                     accept="image/*,.pdf,.doc,.docx"
                     class="payment-file-input">
            </div>
            <div class="form-actions">
              <button type="submit" class="deal-detail-btn" id="registerPaymentSubmit">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>
              <span class="form-message" id="registerPaymentMessage"></span>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
