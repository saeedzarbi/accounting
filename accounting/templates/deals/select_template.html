{% extends "base.html" %}
{% block title %}انتخاب قالب{% endblock %}
{% block body_class %}contract-select-template-page{% endblock %}
{% block extra_head %}
  <style>
    .template-shell {
        width: 100%;
    }

    .template-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .template-card {
        border-radius: 18px;
        padding: 12px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: color-mix(in srgb, var(--color-surface) 92%, transparent);
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        overflow: hidden;
        transition: transform .12s ease, border-color .15s ease, background .15s ease;
    }

    .template-card:hover {
        transform: translateY(-1px);
        border-color: rgba(96,165,250,0.75);
        background: color-mix(in srgb, var(--color-surface-alt) 80%, transparent);
    }

    .template-card.suggested {
        border-color: rgba(34,197,94,0.75);
        background: radial-gradient(circle at top left, rgba(34,197,94,0.14), transparent 55%),
                    color-mix(in srgb, var(--color-surface) 92%, transparent);
    }

    .template-title {
        font-size: 13px;
        font-weight: 900;
        color: var(--color-text);
        font-family: var(--font-title);
        line-height: 1.7;
        padding-left: 76px;
    }

    .template-meta {
        font-size: 11px;
        color: var(--color-text-muted);
        line-height: 1.8;
    }

    .badges {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end;
    }

    .badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--color-border) 60%, transparent);
        background: color-mix(in srgb, var(--color-surface) 92%, transparent);
        color: var(--color-text);
        white-space: nowrap;
    }

    .badge-default {
        border-color: rgba(99,102,241,0.45);
        background: rgba(99,102,241,0.12);
        color: color-mix(in srgb, var(--color-text) 90%, #c7d2fe 10%);
    }

    .badge-suggested {
        border-color: rgba(34,197,94,0.55);
        background: rgba(34,197,94,0.12);
        color: color-mix(in srgb, var(--color-text) 90%, #bbf7d0 10%);
    }

    .settings-box {
        border-radius: 16px;
        border: 1px solid color-mix(in srgb, var(--color-border) 55%, transparent);
        background: color-mix(in srgb, var(--color-surface-alt) 70%, transparent);
        padding: 10px 12px;
        margin-top: 12px;
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 12px;
        color: var(--color-text);
        font-weight: 800;
    }

    .checkbox-wrapper input {
        width: 16px;
        height: 16px;
        margin: 0;
        accent-color: var(--color-accent);
    }

    .template-actions {
        margin-top: auto;
    }

    .select-btn {
        width: 100%;
        padding: 11px 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        font-weight: 800;
        color: #e5f2ff;
        background: linear-gradient(135deg, var(--color-accent), var(--color-accent-soft));
        box-shadow: 0 14px 35px rgba(37,99,235,0.35);
        transition: transform .12s ease, filter .12s ease;
    }

    .select-btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
    }

    .template-card.suggested .select-btn {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        box-shadow: 0 14px 35px rgba(22,163,74,0.35);
    }

    .empty-box {
        border-radius: 18px;
        border: 1px dashed color-mix(in srgb, var(--color-border) 65%, transparent);
        background: color-mix(in srgb, var(--color-bg-soft) 25%, transparent);
        padding: 18px;
        color: var(--color-text-muted);
        font-size: 12px;
        text-align: center;
        grid-column: 1 / -1;
    }

    @media (max-width: 1100px) {
        .template-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 680px) {
        .template-grid { grid-template-columns: minmax(0, 1fr); }
        .template-title { padding-left: 0; }
    }
  </style>
{% endblock %}
{% block content %}
  <section class="page-card template-shell">
    <div class="page-card-inner">
      <h1 class="page-title">
        انتخاب قالب
        <span>مرحله ۳ از ۴</span>
      </h1>
      <p class="page-subtitle">معامله {{ deal.id }} — تاریخ مبایعه: {{ deal.agreement_date|default:"ثبت نشده" }}</p>
      <form method="post">
        {% csrf_token %}
        <div class="settings-box">
          <label class="checkbox-wrapper">
            <input type="checkbox" name="has_header" checked>
            <span>افزودن سربرگ (نام دفتر املاک و تاریخ) به بالای تمام صفحات</span>
          </label>
          <div class="helper-text mt-2">
            پیشنهاد سیستم بر اساس نوع معامله: <span class="pill" style="margin-right:6px;">{{ suggested_mode }}</span>
          </div>
        </div>
        <div class="template-grid">
          {% for template in templates %}
            <div class="template-card {% if template.participant_mode == suggested_mode %}suggested{% endif %}">
              <div class="badges">
                {% if template.is_default %}<span class="badge badge-default">پیشفرض</span>{% endif %}
                {% if template.participant_mode == suggested_mode %}<span class="badge badge-suggested">پیشنهادی</span>{% endif %}
              </div>
              <div class="template-title">{{ template.title }}</div>
              <div class="template-meta">
                نوع: {{ template.get_participant_mode_display }}
                <br>
                مناسب برای: {{ template.transaction_type.name }}
              </div>
              <div class="template-actions">
                <button type="submit"
                        name="template_id"
                        value="{{ template.id }}"
                        class="select-btn">
                  {% if template.participant_mode == suggested_mode %}
                    انتخاب و ایجاد قرارداد (پیشنهادی)
                  {% else %}
                    انتخاب این قالب
                  {% endif %}
                </button>
              </div>
            </div>
          {% empty %}
            <div class="empty-box">هیچ قالبی برای این نوع معامله تعریف نشده است.</div>
          {% endfor %}
        </div>
        <div class="mt-6" style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn-ghost"
             href="{% url 'edit_deal' deal_id=deal.id %}"
             style="width:auto">بازگشت به اطلاعات مبایعه</a>
        </div>
      </form>
    </div>
  </section>
{% endblock %}
